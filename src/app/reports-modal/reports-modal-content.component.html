<!-- Preloader -->
<div class="preloader-block" *ngIf="contentLoading">
  <div class="lds-ring">
    <div></div>
    <div></div>
    <div></div>
    <div></div>
  </div>
</div>
<!-- END Preloader -->

<div class="row">
	<div class="col-md-12">
		<div class="row">
			<div class="col-md-6">
				<h2 mat-dialog-title>{{'REPORTS_MODAL.GET_REPORTS' | translate}}</h2>
			</div>
			<div class="col-md-6">
				<i style="float: right;" class="material-icons" [mat-dialog-close]="true">clear</i>
			</div>
		</div>
	</div>
</div>
<mat-dialog-content class="mat-typography tab-reports" *ngIf="!contentLoading">
	<mat-tab-group (selectedIndexChange)="tabChange($event)" animationDuration="5ms" [selectedIndex]="selected">
		<mat-tab>
			<ng-template mat-tab-label>
				<mat-icon class="reports-catalog-tab-icon">folder_open</mat-icon> {{'REPORTS_MODAL.CATALOG' | translate}}
      </ng-template>
			<form class="example-form">
				<div>
					{{'REPORTS_MODAL.SLICE_MAX' | translate}}
					<mat-form-field appearance="fill" class="example-full-width">
						<input [disabled]=true matInput value="{{data.sliceId}}">
					</mat-form-field>
					{{'REPORTS_MODAL.REPORT_PERIOD' | translate}}
					<mat-form-field appearance="fill" class="example-full-width">
						<input [disabled]=true matInput value="{{data.slicePeriod}}">
					</mat-form-field>
				</div>
				<div>
					<span class="lang-checkbox-label">{{'REPORTS_MODAL.REPORT_LANG' | translate}}</span>
					<mat-checkbox [(ngModel)]="reportLangs.ru.isSelected" name="langRu">
						{{'REPORTS_MODAL.REPORT_RU' | translate}}</mat-checkbox>
					<mat-checkbox [(ngModel)]="reportLangs.kz.isSelected" name="langKz">{{'REPORTS_MODAL.REPORT_KZ' | translate}}
					</mat-checkbox>
				</div>
			</form>
			<div class="reports-list">
				<div class="container-fluid">
					<div class="row">
						<div class="col-sm-6">
							<h3 mat-dialog-title>{{'REPORTS_MODAL.REQUESTED_REPORTS' | translate}}</h3>
							<div class="selected-reports">
								<ul>
									<li *ngFor="let item of selectedReportsList; let i = index">
										<i class="remove-icon pi pi-times-circle" (click)="removeSelectedReport(i, item)"></i>
										<span class="requested-report-item">{{item.report.name}} - {{item.region.name}} -
											{{item.department?.name}}</span>
									</li>
								</ul>
							</div>
						</div>
						<div class="col-sm-6">
							<h3 mat-dialog-title>{{'REPORTS_MODAL.REPORTS' | translate}}
								<span class="readyReportsCounter"
									*ngIf="selectedReportsList.length != 0">{{'REPORTS_MODAL.GOT_REPORTS' | translate}}
									{{readyReportsParts}}
									из {{selectedReportsList.length}}</span>
							</h3>
							<div class="reports">
								<div class="preloader-block ready-reports" *ngIf="isReportsLoading">
									<div class="lds-ring-readyReports">
										<div></div>
										<div></div>
										<div></div>
										<div></div>
									</div>
								</div>
								<ul *ngIf="!isReportsLoading">
									<li *ngFor="let item of readyReports"><a href="{{item.url}}"
											target="_blank">{{item.name | truncate : 55}}</a></li>
								</ul>
							</div>
						</div>
					</div>
				</div>
			</div>
		</mat-tab>
		<!-- Treetable grid for groupCommon -->
		<ng-container *ngIf="isGroupCommon">
			<mat-tab label="{{group.name}}" *ngFor="let group of reportGroups; let index = index">
				<div class="container-fluid">
					<div class="row">
						<div class="col-sm-12">
							<div class="preloader-block" *ngIf="loadingCommon">
								<div class="lds-ring">
									<div></div>
									<div></div>
									<div></div>
									<div></div>
								</div>
							</div>
						</div>
						<div class="col-sm-12" *ngIf="gridData.common != undefined">
							<p-treeTable [value]="gridData.common[group.code]" [columns]="colsCommon" [lazy]="true" [loading]="loadingCommon" dataKey="code" *ngIf="!loadingCommon" (onNodeExpand)="onNodeExpandGroupCommon($event)">
								<ng-template pTemplate="colgroup" let-columns>
									<colgroup>
										<col style="width: 30px;">
										<col style="width: 200px;">
										<col style="width: 200px;">
									</colgroup>
								</ng-template>
								<ng-template pTemplate="header" let-columns>
									<tr>
										<th></th>
										<th *ngFor="let col of columns">{{col.header}}</th>
									</tr>
								</ng-template>
								<ng-template pTemplate="body" let-rowNode let-rowData="rowData" let-columns="columns">
									<tr [ttSelectableRow]="rowNode">
										<td>
											<p-treeTableToggler [rowNode]="rowNode"></p-treeTableToggler>
										</td>
										<td *ngFor="let col of columns; let i = index">
											<!-- <p-treeTableToggler [rowNode]="rowNode"></p-treeTableToggler> -->
											<p-checkbox [(ngModel)]="requestedReports.common[group.code]" [(value)]="rowNode.node.data" *ngIf="i == 0"></p-checkbox>
											{{rowData[col.field]}}
										</td>
									</tr>
								</ng-template>
							</p-treeTable>
						</div>
					</div>
				</div>
			</mat-tab>
		</ng-container>
		<!-- END Treetable grid for GroupCommon -->
		<ng-container *ngIf="!isGroupCommon">
			<mat-tab label="{{group.name}}" *ngFor="let group of reportGroups; let index = index">
				<div class="container-fluid">
					<div class="row">
						<div class="col-sm-12">
							<div class="preloader-block" *ngIf="contentLoading">
								<div class="lds-ring">
									<div></div>
									<div></div>
									<div></div>
									<div></div>
								</div>
							</div>
						</div>
						<!-- Treetable grid for Regions -->
						<div class="col-sm-6" *ngIf="gridData.regs != undefined">
							<p-treeTable [value]="gridData.regs[group.code]" [columns]="colsReg" [lazy]="true" dataKey="code">
								<ng-template pTemplate="header" let-columns>
									<tr>
                    <th>
                      <p-checkbox [binary]="true" (click)="selectAllRows(group.code, requestedReports.regs, gridData.regs, selectAllStatus.regs)" [(ngModel)]="selectAllStatus.regs[group.code]"></p-checkbox>
                    </th>
										<th *ngFor="let col of columns">{{col.header}}</th>
									</tr>
								</ng-template>
								<ng-template pTemplate="body" let-rowNode let-rowData="rowData" let-columns="columns">
									<tr [ttSelectableRow]="rowNode">
										<td>
                      <p-treeTableToggler [rowNode]="rowNode"></p-treeTableToggler>
                      <p-checkbox [(ngModel)]="requestedReports.regs[group.code]" [(value)]="rowNode.node.data"></p-checkbox>
                    </td>
                    <td *ngFor="let col of columns">{{rowData[col.field]}}</td>
									</tr>
								</ng-template>
							</p-treeTable>
						</div>
						<!-- END Treetable grid for Regions -->
						<!-- Treetable grid for Departments -->
						<div class="col-sm-6" *ngIf="gridData.deps != undefined">
							<p-treeTable [value]="gridData.deps[group.code]" [columns]="colsDep" dataKey="code">
								<ng-template pTemplate="header" let-columns>
                  <tr>
                    <th>
                      <p-checkbox [binary]="true" (click)="selectAllRows(group.code, requestedReports.deps, gridData.deps, selectAllStatus.deps)" [(ngModel)]="selectAllStatus.deps[group.code]"></p-checkbox>
                    </th>
										<th *ngFor="let col of columns">{{col.header}}</th>
									</tr>
								</ng-template>
								<ng-template pTemplate="body" let-rowNode let-rowData="rowData" let-columns="columns">
									<tr [ttSelectableRow]="rowNode">
                    <td>
                      <p-checkbox [(ngModel)]="requestedReports.deps[group.code]" [(value)]="rowNode.node.data"></p-checkbox>
                    </td>
										<td *ngFor="let col of columns; let i = index">
											{{rowData[col.field]}}
										</td>
									</tr>
								</ng-template>
							</p-treeTable>
						</div>
						<!-- END Treetable grid for Departments -->
					</div>
				</div>
			</mat-tab>
		</ng-container>
	</mat-tab-group>
</mat-dialog-content>
<mat-dialog-actions *ngIf="!contentLoading" align="end">
	<button mat-flat-button color="primary" (click)=getReports() *ngIf="selected === 0"
		[disabled]="!isReportsSelected">{{'REPORTS_MODAL.BTN_GET_REPORTS' | translate}}</button>
	<button mat-flat-button color="primary" (click)=openFirstTab()
		*ngIf="selected !== 0">{{'REPORTS_MODAL.BTN_GET_REPORTS' | translate}}</button>
	<button mat-flat-button color="primary" mat-dialog-close>{{'REPORTS_MODAL.BTN_CANCEL' | translate}}</button>
</mat-dialog-actions>
